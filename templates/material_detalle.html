<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Detalle | Intralu</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <style>
      .admin-panel-material {
          background-color: rgba(255, 255, 255, 0.05);
          border: 1px solid #d73a49; /* Borde rojo para destacar que es admin */
          padding: 20px;
          border-radius: 8px;
          margin-top: 30px;
      }
      .admin-table {
          width: 100%;
          border-collapse: collapse;
          margin-top: 10px;
      }
      .admin-table th, .admin-table td {
          text-align: left;
          padding: 10px;
          border-bottom: 1px solid var(--border-color);
          color: var(--text-muted);
      }
      .admin-table th { color: #fff; font-weight: bold; }
      .status-active { color: #2ea043; }
      .status-overdue { color: #d73a49; font-weight: bold; }
      .badge-queue {
          background-color: #d29922;
          color: #000;
          font-weight: bold;
          padding: 5px 10px;
          border-radius: 4px;
          display: inline-block;
          margin-bottom: 10px;
      }
  </style>
</head>
<body>

  <div class="app-wrapper">
    <nav class="sidebar" id="mainSidebar">
      <div class="sidebar-header">
        <span class="brand-icon">üèõÔ∏è</span>
        <span class="brand-title">INTRALU</span>
        <span class="menu-icon" id="sidebarToggle">‚â°</span>
      </div>

      <ul class="nav-links">
        <a href="{{ url_for('home', view='catalogo') }}" class="nav-item">
          <div class="nav-icon">üîç</div> <span class="nav-text">Cat√°logo</span>
        </a>
        <a href="{{ url_for('home', view='prestamos') }}" class="nav-item">
          <div class="nav-icon">üìö</div> <span class="nav-text">Pr√©stamos</span>
        </a>
        {% if session.rol == 'Administrativo' %}
        <a href="{{ url_for('home', view='admin') }}" class="nav-item">
          <div class="nav-icon">üìä</div> <span class="nav-text">Admin</span>
        </a>
        {% endif %}
      </ul>

      <div class="sidebar-footer">
        <div class="user-profile-card">
            <div class="avatar-circle">{{ session.nombre[0] }}</div>
            <div class="user-details">
                <span class="user-name">{{ session.nombre.split(' ')[0] }}</span>
                <span class="user-role">{{ session.rol }}</span>
            </div>
        </div>
        <a href="{{ url_for('perfil') }}" class="footer-link link-profile">
            <div class="footer-icon">üë§</div> <span>Mi Perfil</span>
        </a>
        <a href="{{ url_for('logout') }}" class="footer-link link-logout">
            <div class="footer-icon">üö™</div> <span>Salir</span>
        </a>
      </div>
    </nav>

    <main class="main-content">
      <a href="{{ url_for('home') }}" class="btn-secondary" style="margin-bottom:20px; display:inline-block;">&larr; Volver</a>
      
      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          {% for category, message in messages %}
            <div class="flash-message {{ category }}">{{ message }}</div>
          {% endfor %}
        {% endif %}
      {% endwith %}

      <div class="detalle-wrapper">
        <div class="detalle-main-card">
            <div class="detalle-portada">
                <img src="{{ material.portada_url }}">
            </div>
            <div class="detalle-content">
                <div class="detalle-titulo">{{ material.titulo }}</div>
                <div class="detalle-autor">por {{ material.autor }} ‚Ä¢ {{ material.a√±o_publicacion }}</div>
                
                <div style="margin-bottom:15px; display:flex; gap:10px; align-items:center;">
                    <span style="background:#1f6feb; color:#fff; padding:4px 8px; border-radius:4px; font-size:0.9em; font-weight:bold;">{{ material.materia }}</span>
                    <span style="color:#e3b341; font-weight:bold;">
                        ‚òÖ {{ material.promedio_calificacion }} <span style="color:var(--text-muted); font-weight:normal;">({{ material.resenas|length }} rese√±as)</span>
                    </span>
                </div>

                <div class="detalle-desc">{{ material.descripcion }}</div>
                
                <div class="detalle-specs">
                    <div class="spec-row">
                        <span class="spec-label">Tipo:</span> <span class="spec-value">{{ material.__class__.__name__ }}</span>
                    </div>
                    
                    {% if material.__class__.__name__ == 'Libro' %}
                      <div class="spec-row"><span class="spec-label">Editorial:</span><span class="spec-value">{{ material.editorial }}</span></div>
                      <div class="spec-row"><span class="spec-label">ISBN:</span><span class="spec-value">{{ material.isbn }}</span></div>
                    {% elif material.__class__.__name__ == 'Revista' %}
                      <div class="spec-row"><span class="spec-label">Edici√≥n:</span><span class="spec-value">N¬∫ {{ material.numero_edicion }}</span></div>
                      <div class="spec-row"><span class="spec-label">ISSN:</span><span class="spec-value">{{ material.issn }}</span></div>
                    {% elif material.__class__.__name__ == 'Tesis' %}
                      <div class="spec-row"><span class="spec-label">Universidad:</span><span class="spec-value">{{ material.universidad }}</span></div>
                    {% elif material.__class__.__name__ == 'MaterialDigital' %}
                      <div class="spec-row"><span class="spec-label">Formato:</span><span class="spec-value">{{ material.formato }}</span></div>
                    {% endif %}

                    {% if material.__class__.__name__ != 'MaterialDigital' %}
                    <div class="spec-row">
                        <span class="spec-label">Stock Total:</span>
                        <span class="spec-value" style="color:#e6edf3; font-weight:bold;">{{ material.total_unidades }} ejemplares</span>
                    </div>
                    {% endif %}

                    <div class="spec-row">
                        <span class="spec-label">Estado:</span>
                        {% if material.esta_disponible %}
                            <span class="spec-value" style="color:#2ecc71">Disponible ({{ material.unidades_disponibles }})</span>
                        {% else %}
                            <span class="spec-value" style="color:#d73a49">Agotado (0 disponibles)</span>
                        {% endif %}
                    </div>
                </div>

                <div style="display:flex; gap:10px; flex-direction:column;">
                    
                    {% if puede_prestar %}
                        <form action="{{ url_for('prestar_material', material_id=material.id) }}" method="POST">
                            <button class="btn-primary" style="width:100%; padding:15px; font-size:1.1em;">
                                {% if material.__class__.__name__ == 'MaterialDigital' %}
                                    Leer Ahora
                                {% else %}
                                    Solicitar Pr√©stamo
                                {% endif %}
                            </button>
                        </form>
                    {% elif mostrar_reserva %}
                        {% if posicion_cola > 0 %}
                            <div style="text-align:center; padding:15px; background:rgba(210, 153, 34, 0.1); border:1px solid #d29922; border-radius:6px;">
                                <span class="badge-queue">¬°Est√°s reservado!</span><br>
                                <span style="color:#e6edf3">Tu posici√≥n en la cola: <strong>#{{ posicion_cola }}</strong></span>
                            </div>
                        {% else %}
                             <form action="{{ url_for('reservar_material', material_id=material.id) }}" method="POST">
                                <button class="btn-secondary" style="width:100%; padding:15px; font-size:1.1em; border-color:#d29922; color:#d29922;">
                                    üìÖ Reservar en Cola de Espera
                                </button>
                            </form>
                            <p style="color:#8b949e; font-size:0.9em; text-align:center; margin-top:5px;">
                                Te avisaremos cuando se devuelva un ejemplar.
                            </p>
                        {% endif %}
                    {% else %}
                        <button disabled class="btn-secondary" style="width:100%; opacity:0.5;">No disponible para pr√©stamo</button>
                    {% endif %}


                    {% if session.rol == 'Administrativo' %}
                    <form action="{{ url_for('admin_retirar_material', material_id=material.id) }}" method="POST" onsubmit="return confirm('¬øEst√°s seguro de eliminar este material permanentemente?');">
                        <button class="btn-danger" style="width:100%; padding:10px;">Eliminar Material del Cat√°logo</button>
                    </form>
                    {% endif %}
                </div>
                
                {% if not puede_prestar and razon and not mostrar_reserva %}<p style="color:#d73a49; text-align:center; margin-top:10px;">{{ razon }}</p>{% endif %}
            </div>
        </div>

        <!-- SECCI√ìN DE RESE√ëAS -->
        <div class="reviews-container" style="margin-top:30px;">
            <h3 style="border-bottom:1px solid var(--border-color); padding-bottom:10px;">Rese√±as y Opiniones</h3>
            
            <div class="review-form-card" style="background:var(--bg-panel); padding:20px; border-radius:8px; border:1px solid var(--border-color); margin-bottom:20px;">
                <h4 style="margin-top:0;">Dejar una rese√±a</h4>
                <form action="{{ url_for('comentar_material', material_id=material.id) }}" method="POST">
                    <div style="display:flex; gap:15px; margin-bottom:15px;">
                        <div style="flex:1;">
                            <label style="display:block; margin-bottom:5px; color:#ccc;">Calificaci√≥n</label>
                            <select name="calificacion" style="width:100%; color:#e3b341; font-weight:bold;">
                                <option value="5">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ (5)</option>
                                <option value="4">‚òÖ‚òÖ‚òÖ‚òÖ‚òÜ (4)</option>
                                <option value="3">‚òÖ‚òÖ‚òÖ‚òÜ‚òÜ (3)</option>
                                <option value="2">‚òÖ‚òÖ‚òÜ‚òÜ‚òÜ (2)</option>
                                <option value="1">‚òÖ‚òÜ‚òÜ‚òÜ‚òÜ (1)</option>
                            </select>
                        </div>
                    </div>
                    <div style="margin-bottom:15px;">
                        <label style="display:block; margin-bottom:5px; color:#ccc;">Comentario</label>
                        <textarea name="comentario" rows="3" placeholder="¬øQu√© te pareci√≥ este material?" style="width:100%; background:#0d1117; color:#fff; border:1px solid var(--border-color); border-radius:6px; padding:10px;"></textarea>
                    </div>
                    <button class="btn-secondary" style="font-size:0.9em;">Publicar Opini√≥n</button>
                </form>
            </div>

            <div class="reviews-list">
                {% if material.resenas %}
                    {% for resena in material.resenas %}
                    <div class="review-item" style="border-bottom:1px solid var(--border-color); padding:15px 0;">
                        <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                            <span style="font-weight:bold; color:#fff;">{{ resena.usuario.nombre }}</span>
                            <span style="color:#e3b341;">
                                {% for i in range(resena.calificacion) %}‚òÖ{% endfor %}{% for i in range(5 - resena.calificacion) %}‚òÜ{% endfor %}
                            </span>
                        </div>
                        <p style="margin:5px 0; color:#c9d1d9;">{{ resena.comentario }}</p>
                        <small style="color:var(--text-muted);">Publicado el {{ resena.fecha.strftime('%d-%m-%Y') }}</small>
                    </div>
                    {% endfor %}
                {% else %}
                    <p style="color:var(--text-muted); font-style:italic;">A√∫n no hay rese√±as para este material. ¬°S√© el primero!</p>
                {% endif %}
            </div>
        </div>

        <!-- PANEL DE ADMINISTRACI√ìN (SOLO VISIBLE PARA ADMIN) -->
        {% if session.rol == 'Administrativo' %}
        <div class="admin-panel-material">
            <h3 style="color:#ff7b72; margin-top:0;">üîê Panel de Gesti√≥n del Material</h3>
            
            <div style="display:flex; gap:30px; flex-wrap:wrap;">
                <!-- COLUMNA 1: QUI√âN LO TIENE -->
                <div style="flex:1; min-width:300px;">
                    <h4>üìñ Usuarios con ejemplares en posesi√≥n</h4>
                    {% if prestamos_activos_material %}
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>Usuario</th>
                                <th>Vence</th>
                                <th>Estado</th>
                                <th>Multa</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in prestamos_activos_material %}
                            <tr>
                                <td>
                                    <strong>{{ item.usuario.nombre }}</strong><br>
                                    <small>{{ item.usuario.correo }}</small>
                                </td>
                                <td>{{ item.prestamo.fecha_vencimiento.strftime('%d-%m-%Y') }}</td>
                                <td>
                                    {% if item.estado == 'PrestamoActivo' %}
                                        <span class="status-active">Al d√≠a</span>
                                    {% else %}
                                        <span class="status-overdue">Vencido</span>
                                    {% endif %}
                                </td>
                                <!-- CAMBIO DE MONEDA AQU√ç -->
                                <td>S/. {{ item.deuda }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    {% else %}
                    <p style="color:var(--text-muted)">Nadie tiene este material prestado actualmente.</p>
                    {% endif %}
                </div>

                <!-- COLUMNA 2: COLA DE RESERVA -->
                <div style="flex:1; min-width:300px;">
                    <h4>‚è≥ Cola de Reserva (En orden)</h4>
                    {% if material.lista_reservas %}
                    <ol style="padding-left:20px; color:#e6edf3;">
                        {% for res_user in material.lista_reservas %}
                        <li style="margin-bottom:10px;">
                            <strong>{{ res_user.nombre }}</strong> <span style="color:var(--text-muted)">({{ res_user.rol }})</span>
                        </li>
                        {% endfor %}
                    </ol>
                    {% else %}
                    <p style="color:var(--text-muted)">No hay nadie en la cola de espera.</p>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endif %}

        {% if recomendaciones %}
        <div class="recomendaciones-section">
            <h3>Recomendados</h3>
            <ul class="recomendaciones-list">
              {% for mat in recomendaciones %}
              <li>
                <a href="{{ url_for('detalle_material', material_id=mat.id) }}" class="rec-item-link">
                  <img src="{{ mat.portada_url }}" class="rec-thumb">
                  <div class="rec-info"><strong>{{ mat.titulo }}</strong><span>{{ mat.autor }}</span></div>
                </a>
              </li>
              {% endfor %}
            </ul>
        </div>
        {% endif %}
      </div>
    </main>
  </div>

  <script>
    const toggleBtn = document.getElementById('sidebarToggle');
    const sidebar = document.getElementById('mainSidebar');
    if(localStorage.getItem('sidebarState') === 'collapsed') sidebar.classList.add('collapsed');
    
    if(toggleBtn) {
        toggleBtn.addEventListener('click', () => {
            sidebar.classList.toggle('collapsed');
            localStorage.setItem('sidebarState', sidebar.classList.contains('collapsed') ? 'collapsed' : 'expanded');
        });
    }
  </script>
</body>
</html>
